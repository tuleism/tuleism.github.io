<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Zero Downtime Reindex in Elasticsearch | Random.nextBlog</title><meta name="gridsome:hash" content="25a5d663bc74a8a307f4df8ab380b824472878c6"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="theme-color" content="#10c186"><meta data-vue-tag="ssr" name="google-site-verification" content="cwS6wWeYJ-lTlEh9mPtc_UOGJjRptMvsO0nOQvqrzD4"><meta data-vue-tag="ssr" name="apple-mobile-web-app-status-bar-style" content="default"><meta data-vue-tag="ssr" name="author" content="Linh Nguyen"><meta data-vue-tag="ssr" name="copyright" content="Linh Nguyen, 2021. All rights reserved"><meta data-vue-tag="ssr" property="og:image" content="https://tuleism.github.io/logo-512.png"><meta data-vue-tag="ssr" name="twitter:card" content="summary"><meta data-vue-tag="ssr" name="twitter:site" content="@tuleism"><meta data-vue-tag="ssr" name="twitter:image" content="https://tuleism.github.io/logo-512.png"><meta data-vue-tag="ssr" data-key="description" name="description" content="A generic, eventually consistent, zero downtime solution to reindex data in ElasticSearch."><meta data-vue-tag="ssr" property="og:type" content="article"><meta data-vue-tag="ssr" property="og:description" content="A generic, eventually consistent, zero downtime solution to reindex data in ElasticSearch."><meta data-vue-tag="ssr" property="og:site_name" content="Random.nextBlog"><meta data-vue-tag="ssr" property="og:title" content="Zero Downtime Reindex in Elasticsearch"><meta data-vue-tag="ssr" property="og:url" content="https://tuleism.github.io/blog/2021/elasticsearch-zero-downtime-reindex/"><meta data-vue-tag="ssr" name="article:author" content="Linh Nguyen"><meta data-vue-tag="ssr" name="article:published_time" content="2021-08-22"><meta data-vue-tag="ssr" name="twitter:title" content="Zero Downtime Reindex in Elasticsearch"><meta data-vue-tag="ssr" name="twitter:description" content="A generic, eventually consistent, zero downtime solution to reindex data in ElasticSearch."><meta data-vue-tag="ssr" name="twitter:url" content="https://tuleism.github.io/blog/2021/elasticsearch-zero-downtime-reindex/"><meta data-vue-tag="ssr" name="article:tag" content="elasticsearch"><meta data-vue-tag="ssr" name="article:tag" content="architecture"><meta data-vue-tag="ssr" name="article:tag" content="distributed-systems"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="manifest" href="/manifest.json"><link rel="preload" href="/assets/css/0.styles.996c65bd.css" as="style"><link rel="preload" href="/assets/js/app.185c96bb.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--doc-vue.fff5180d.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.b8c718d9.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.2b6aa2f3.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.dc2a659f.js"><link rel="stylesheet" href="/assets/css/0.styles.996c65bd.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="site" data-v-0431039b data-v-11d90a72><header class="header" data-v-1c71a4d0 data-v-0431039b><a href="/" title="Back to home" class="blog-name active" data-v-dd29784a data-v-1c71a4d0><span data-v-dd29784a>tuleisM &gt;&gt;= Random.nextBlog</span></a><nav class="nav" data-v-1c71a4d0><button id="themeSwitch" aria-label="Switch theme between light and dark" data-v-385ac126 data-v-1c71a4d0><!----><!----></button><button aria-label="Toggle the sidebar" class="toggle" data-v-def1a688 data-v-1c71a4d0><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="open feather feather-menu" data-v-def1a688 data-v-def1a688><line x1="3" y1="12" x2="21" y2="12" data-v-def1a688></line><line x1="3" y1="6" x2="21" y2="6" data-v-def1a688></line><line x1="3" y1="18" x2="21" y2="18" data-v-def1a688></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close feather feather-x" style="display:none;" data-v-def1a688 data-v-def1a688><line x1="18" y1="6" x2="6" y2="18" data-v-def1a688></line><line x1="6" y1="6" x2="18" y2="18" data-v-def1a688></line></svg></button></nav></header><aside class="sidebar" data-v-34cfceb7 data-v-0431039b><nav data-v-34cfceb7><hr class="dashed" data-v-34cfceb7><div class="icons" data-v-34cfceb7><a href="/" title="Blog" class="topic" data-v-34cfceb7>blog</a><a href="/about/" title="About Me" class="topic" data-v-34cfceb7><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-info" data-v-34cfceb7><circle cx="12" cy="12" r="10" data-v-34cfceb7></circle><line x1="12" y1="16" x2="12" y2="12" data-v-34cfceb7></line><line x1="12" y1="8" x2="12.01" y2="8" data-v-34cfceb7></line></svg></a><a title="GitHub @tuleism" href="https://github.com/tuleism" target="_blank" rel="noopener" class="topic" data-v-34cfceb7 data-v-34cfceb7><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-github" data-v-34cfceb7 data-v-34cfceb7><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-34cfceb7 data-v-34cfceb7></path></svg></a><a title="LinkedIn @tuleism" href="https://www.linkedin.com/in/tuleism" target="_blank" rel="noopener" class="topic" data-v-34cfceb7 data-v-34cfceb7><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-linkedin" data-v-34cfceb7 data-v-34cfceb7><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-34cfceb7 data-v-34cfceb7></path><rect x="2" y="9" width="4" height="12" data-v-34cfceb7 data-v-34cfceb7></rect><circle cx="4" cy="4" r="2" data-v-34cfceb7 data-v-34cfceb7></circle></svg></a><a title="Twitter @tuleism" href="https://www.twitter.com/tuleism" target="_blank" rel="noopener" class="topic" data-v-34cfceb7 data-v-34cfceb7><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-twitter" data-v-34cfceb7 data-v-34cfceb7><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-34cfceb7 data-v-34cfceb7></path></svg></a><a title="Instagram @randomphotohereandthere" href="https://www.instagram.com/randomphotohereandthere" target="_blank" rel="noopener" class="topic" data-v-34cfceb7 data-v-34cfceb7><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-instagram" data-v-34cfceb7 data-v-34cfceb7><rect x="2" y="2" width="20" height="20" rx="5" ry="5" data-v-34cfceb7 data-v-34cfceb7></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" data-v-34cfceb7 data-v-34cfceb7></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5" data-v-34cfceb7 data-v-34cfceb7></line></svg></a><a title="Contact Me" href="mailto:tuleism@gmail.com" class="topic" data-v-34cfceb7 data-v-34cfceb7><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-mail" data-v-34cfceb7 data-v-34cfceb7><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-34cfceb7 data-v-34cfceb7></path><polyline points="22,6 12,13 2,6" data-v-34cfceb7 data-v-34cfceb7></polyline></svg></a></div><hr class="dashed" data-v-34cfceb7><h3 class="section-title" data-v-34cfceb7>Table of Contents</h3><ul data-v-34cfceb7><li data-v-34cfceb7><a href="/blog/2021/elasticsearch-zero-downtime-reindex/#why-reindexing-data-in-elasticsearch" class="sub-topic" data-v-34cfceb7>Why reindexing data in Elasticsearch?</a></li><li data-v-34cfceb7><a href="/blog/2021/elasticsearch-zero-downtime-reindex/#prior-arts" class="sub-topic" data-v-34cfceb7>Prior arts</a></li><li data-v-34cfceb7><a href="/blog/2021/elasticsearch-zero-downtime-reindex/#a-generic-solution" class="sub-topic" data-v-34cfceb7>A generic solution</a></li></ul></nav></aside><main class="main" data-v-0431039b><div data-v-0431039b data-v-11d90a72><span class="date" data-v-0431039b data-v-11d90a72>Posted 22 Aug 2021 by </span><a href="/about/" title="About Me" class="topic" data-v-11d90a72>Linh Nguyen</a></div><h1 data-v-0431039b data-v-11d90a72>
    Zero Downtime Reindex in Elasticsearch
  </h1><div class="markdown" data-v-0431039b data-v-11d90a72><h2 id="why-reindexing-data-in-elasticsearch"><a href="#why-reindexing-data-in-elasticsearch" aria-hidden="true"><span class="icon icon-link"></span></a>Why reindexing data in Elasticsearch?</h2>
<p>Reindexing data is a common operation in working with Elasticsearch. When do we need to do it? Here are a few examples:</p>
<ol>
<li><strong>Mapping change</strong>: when we change how data is analyzed and indexed. For example: changing a field's analyzer, changing an analyzer's definition, etc.</li>
<li><strong>Cluster upgrade or migration</strong>: Elasticsearch can only read indices created in the previous major version <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/reindex-upgrade.html" target="_blank" rel="nofollow noopener noreferrer">since 5.x</a>. So if we want to upgrade our Elasticsearch that is several major versions behind, we have to resort to reindexing. For example, Elasticsearch support <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/reindex-upgrade-remote.html" target="_blank" rel="nofollow noopener noreferrer">reindexing from a remote cluster</a>.</li>
</ol>
<h2 id="prior-arts"><a href="#prior-arts" aria-hidden="true"><span class="icon icon-link"></span></a>Prior arts</h2>
<p>We take a look at some available solutions to implement reindexing and analyze their pros and cons.</p>
<h3 id="elasticsearchs-official-reindex-api"><a href="#elasticsearchs-official-reindex-api" aria-hidden="true"><span class="icon icon-link"></span></a>Elasticsearch's <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html" target="_blank" rel="nofollow noopener noreferrer">official Reindex API</a></h3>
<h4 id="pros"><a href="#pros" aria-hidden="true"><span class="icon icon-link"></span></a>Pros</h4>
<ul>
<li>Easy: not much work to do since it's readily available.</li>
<li>Fastest solution.</li>
<li>Work for both: reindex within the same cluster or reindex from a remote cluster.</li>
<li>Works well if we can stop indexing data for a while (to wait for the reindex process to finish).</li>
</ul>
<h4 id="cons"><a href="#cons" aria-hidden="true"><span class="icon icon-link"></span></a>Cons</h4>
<ul>
<li>Hard to reason about consistency if writes still come to the old index during the reindex process.</li>
<li>Meant for indices that must be "paused", so not really zero downtime.</li>
<li>Only work with data that are already in Elasticsearch.</li>
</ul>
<h3 id="index-alias-wizardry"><a href="#index-alias-wizardry" aria-hidden="true"><span class="icon icon-link"></span></a>Index Alias Wizardry</h3>
<p>In Elasticsearch, alias works as a <strong>pointer</strong> to one or multiple indices. <a href="https://www.elastic.co/blog/changing-mapping-with-zero-downtime" target="_blank" rel="nofollow noopener noreferrer">Many</a> <a href="https://blog.codecentric.de/en/2014/09/elasticsearch-zero-downtime-reindexing-problems-solutions/" target="_blank" rel="nofollow noopener noreferrer">have</a> <a href="https://medium.com/craftsmenltd/rebuild-elasticsearch-index-without-downtime-168363829ea4" target="_blank" rel="nofollow noopener noreferrer">written</a> about using it for zero downtime reindexing: using one alias or using two, one for read and one for write, etc.</p>
<p>Basically it works like this:</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 771 181' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-447767732103bd1799ea088779d87a4e'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-447767732103bd1799ea088779d87a4e)' width='771' height='181' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAPCAYAAABUZ8lnAAAACXBIWXMAAAsSAAALEgHS3X78AAADPElEQVRIx82XC0tqQRDHz/f/PlJJUUlFUUZklr0tSDO10rKHlRO/gb%2bse4%2bd0%2bWCd2DYPfuY987MSfr9vrXbbet0Oj6GqLVer2fAaDTKRM5m0YNnTA94f38fn7m7u3NMO6vzjF9fXxPfmmfpBe3n52dLbm9v7fPz097e3mw4HPocZM7ax8eHPT4%2b%2buEs4A4MuMMc4ZiDzFGQ9YeHB3t5efnjfqPRGCsMIEe9Xk/lBb1p39C%2bv793vvCUPtINvTDUxcWFJVhCwAUURQgOCiCCcOzrsgixJ%2bOhfLfb9Tuvr68eDaxzhrmERMDQ8KKBQBgbGijAnDXkkUPEC0D2g4MDvw/IYdxX1MLz6enJ7zCCkqNSqVjSarXGijabTZubm3MM1xH47OzMPcf61taW7e7ueigJUX5jY8Nk0PPzc5ufn7e9vT3b39%2b3QqHgRgSgc3R05Apyj%2b%2brqytbXV0dG0yCHh4eOq/wacHj9PTUaXCnXC47P/Yw3PX1tY8AI2dqtZqtra3ZysqKDQYD38N4ExEwDRBIBOVdeSF%2bAiiTBdwnAmJAllKp5Abb3t62YrHoSsZA5OAQaKDsycnJxFNRFGeBG%2bDm5iY1UYQJA68jtBKNIC2J4eWYXvgtD0IPQcMkxl6YG9hDSZ0JeaWB9ngKyPyTXjiUqEuwJoL/hLyrkEGcicNvJZ489IgYGVaeRTCQSAoNMi37M6YZKEsOjMS9xHJCyDzrzG/ooWD8nHijhLCSVV66eWSMIclT22Pr/8T4b%2bihsLyJ91UFCNXw6eXlE0aXKkeM7BFxuSPgX0JsTJVXFA/7DfZJcgiaJwcIoEWegZ7yQFixQJ4YtGdigDQjIDRZGcHVCTKmNUIIz74StPoP5oyU0DxVoFqtzs4AaYagBMadHfV%2bZ2fHewYpTR%2byvLxs6%2bvr3mdQ3ymbS0tLvkbzpHKMlxcWFrxP2NzcnOhxvBH6H5SXspTkxcVFOz4%2bdpRCSpQ8BYxAU0OvANIDcJa%2bAGOgFEgUhN0tCB3yjarQzA0QJzd6CLpRuj48SGhfXl7%2bmiZljqcQtukhkgAxOlExcwOEkaC/QbyEgCiR9jeo2p%2bGSpjcg5YSYYhaI0q%2bAXoAj8YYKTREAAAAAElFTkSuQmCC' /%3e%3c/svg%3e" width="771" alt="Zero Downtime Reindexing using alias" data-srcset="/assets/static/esalias.7b44e8d.e10f461f73ac118cabbf600d0daaab7e.png 771w" data-sizes="(max-width: 771px) 100vw, 771px" data-src="/assets/static/esalias.7b44e8d.e10f461f73ac118cabbf600d0daaab7e.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/esalias.7b44e8d.e10f461f73ac118cabbf600d0daaab7e.png" width="771" alt="Zero Downtime Reindexing using alias"></noscript></p>
<ul>
<li>Applications don't query the index directly, but through an alias <code class="language-inline-text">index_alias</code>.</li>
<li>The alias points to the <strong>current</strong> index <code class="language-inline-text">current_index</code>.</li>
<li>When we want to reindex data, we create a new index <code class="language-inline-text">new_index</code>, probably with a new mapping.</li>
<li>Then we duplicate write: we write to both <code class="language-inline-text">current_index</code> and <code class="language-inline-text">new_index</code> at the same time.</li>
<li>Once <code class="language-inline-text">new_index</code> has caught up with <code class="language-inline-text">current_index</code>, we update the alias to point to <code class="language-inline-text">new_index</code> instead of <code class="language-inline-text">current_index</code>. This can be done <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-aliases.html" target="_blank" rel="nofollow noopener noreferrer">atomically</a>.</li>
<li>If anything goes wrong, we just have to revert the final alias change.</li>
</ul>
<h4 id="pros-1"><a href="#pros-1" aria-hidden="true"><span class="icon icon-link"></span></a>Pros</h4>
<ul>
<li>Straightforward.</li>
<li>Revertible.</li>
<li>Can include new fields from the source of truth outside of Elasticsearch.</li>
</ul>
<h4 id="cons-1"><a href="#cons-1" aria-hidden="true"><span class="icon icon-link"></span></a>Cons</h4>
<ul>
<li>Only work within one Elasticsearch cluster.</li>
<li>Requires quite some work, but handles only one use case.</li>
<li>Most solutions don't mention how to keep data consistent between <code class="language-inline-text">current_index</code> and <code class="language-inline-text">new_index</code>.</li>
</ul>
<h2 id="a-generic-solution"><a href="#a-generic-solution" aria-hidden="true"><span class="icon icon-link"></span></a>A generic solution</h2>
<p>Above solutions are <strong>purely about data</strong> coming into Elasticsearch. However, not only data, but the <strong>applications</strong> that read and write these data are also important aspects to consider when we want to rollout a reindex operation.</p>
<p>For example, when we do a major mapping change, we might need to update application code to be able to query from the new index.</p>
<p>For upgrading Elasticsearch server version, we usually have to update the application code since the API <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes.html" target="_blank" rel="nofollow noopener noreferrer">might have changed</a>.
If we were to use a library like <a href="https://github.com/sksamuel/elastic4s" target="_blank" rel="nofollow noopener noreferrer">elastic4s</a>, upgrading server means upgrading client library <a href="https://github.com/sksamuel/elastic4s#release" target="_blank" rel="nofollow noopener noreferrer">at the same time</a>.
To guarantee zero downtime, we need to be able to release application code and the new cluster version independently. How can we achieve that if we don't care about application code?</p>
<p>By incorporating these considerations, we can achieve a generic reindexing solution that works for all mentioned use cases, while having no downtime.</p>
<p>If we call this a recipe for reindexing, then here are the required ingredients:</p>
<ol>
<li>A <strong>data source</strong> that supports <strong>deterministic replay</strong> and <strong>multiple concurrent readers</strong>. Example: a <a href="https://www.confluent.io/blog/apache-kafka-intro-how-kafka-works/#kafka-topics" target="_blank" rel="nofollow noopener noreferrer">Kafka topic</a>, a <a href="https://debezium.io/" target="_blank" rel="nofollow noopener noreferrer">change data capture</a> stream, etc. Why? Because it allows us to have multiple independent writers/indexers that write/index the same set of data into different Elasticsearch indices in possibly different clusters.</li>
<li><strong>Decoupling</strong> between <strong>readers</strong> (applications that query from Elasticsearch) and <strong>writers</strong> (applications that write/index into Elasticsearch). Why? Because it allows us to <strong>separate their deployment</strong> (think microservices' <a href="https://microservices.io/patterns/microservices.html" target="_blank" rel="nofollow noopener noreferrer">independently deployable</a>). As a result, we can <strong>scale</strong> and <strong>upgrade</strong> them independently. We will also see later that it allows us to easily <strong>upgrade Elasticsearch code</strong> from any arbitrary version.</li>
<li>Writers that guarantee <a href="https://microservices.io/patterns/communication-style/idempotent-consumer.html" target="_blank" rel="nofollow noopener noreferrer">idempotent processing</a> under at-least-once delivery. Why? Because combining this with the data source above, we can <strong>guarantee data consistency</strong> - all old and new indices will eventually have the same data.</li>
</ol>
<p>Here's how the most basic architecture looks like in normal operation:</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 951 161' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-693392375c29abd54a04c7c74fc528ee'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-693392375c29abd54a04c7c74fc528ee)' width='951' height='161' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAALCAYAAADP9otxAAAACXBIWXMAAAsSAAALEgHS3X78AAACz0lEQVRIx72Wy25aQQyGebE%2bQt%2bhb9F11132BVqp78AmCxaQoHBVghSUCxARIAn3hHAnzvnc%2bmgymRIioVqyZo7HHv/22DMnMZ/PZbFYvOHVaiXQ8/NzPNocCtkYG6G/2Wx0/vj4KK1WS7rdrrTbbel0Oq8YGWvNZjPokzGEFdk2rKyFMGIHtsRoNJLxeCyM7nw4HMpsNtNNUHSDeXh4kMFgoLqmb3PsWHeTBT09PakeayRjMpko25wR7vV6cQDG%2bMWf68f3OZ1O1c96vY59gp81NzbT55uEJyxLOIFtAxwDJkT9fj8Ghy0jdsvlUtcBi4yxUqlo8KxxymQe4htb1w7A9Xr9jT902MvmsPk0vJa4QqEgx8fHKidINyH4cb%2bvr68lAYijoyM5PT1V42KxqIYQ3wA6PDzUOUwQ9/f3Cvbk5ERKpZJcXFxIuVyWXC6ndnd3d6qDbTKZ1BKn/NPptAaNY3RJTrVaVTk%2bqYSDgwMNBkxgYc5erN/e3ko%2bn1e/%2bEylUjqHwHF1daUybMF5c3MTJ5dDQw5OO4RGo/GnAuz0rdRNRokwYsBG9A7fgDJdn82Z3SMAR04VkAS/rdzWooxrtZrKmKPLibGXVYBv57YInMlkJJvNxkmzBPgtFVcAYI3ZwP22TPlEH5MEX9%2bYXvaJgOi9Qb8b6XSDdqyTdJ%2bsnXyM7tywugeBLOTHbPUOCJ2if/vuKvdfCjfbdulpH7Om65tXunZ/mE1ov/ew%2bvu9Z5OQLeRvHHL0Lztfl6qYzaIncpKKLolf0cLq7zO1fFVpnI6bgFAi3sP6EZxbK8DfYJeshqpEA11vpFLOy7evn%2bV35qcsltOovzd6EXEZ2vtst3noRD%2bCdVebrRWwD4oTEF1GZ%2bfn8un7D/mSq0m93ZFS9KoQ/OXlpb4KvAhcXtuC2jf9twTQAgRX6LYl3TjTUrcfLvqeEebp2rWE90EvAEmqipm0hYsAAAAASUVORK5CYII=' /%3e%3c/svg%3e" width="951" alt="Zero Downtime Reindexing Recipe" data-srcset="/assets/static/recipe.82a2fbd.01cee721502497cbfed2a6074486bbb2.png 480w, /assets/static/recipe.5321fa8.01cee721502497cbfed2a6074486bbb2.png 951w" data-sizes="(max-width: 951px) 100vw, 951px" data-src="/assets/static/recipe.5321fa8.01cee721502497cbfed2a6074486bbb2.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/recipe.5321fa8.01cee721502497cbfed2a6074486bbb2.png" width="951" alt="Zero Downtime Reindexing Recipe"></noscript></p>
<ul>
<li>We have one writer/indexer <code class="language-inline-text">current_writer</code> that writes/indexes into <code class="language-inline-text">current_index</code>.</li>
<li>A separate reader <code class="language-inline-text">current_reader</code> query from that index and forward the results to the clients. Alternatively, the reader can be a shared library embedded in the client applications.</li>
</ul>
<p>Let's see how it evolves when we want to reindex data.</p>
<h3 id="example-1-reindex-into-the-same-cluster-eg-when-mapping-changes"><a href="#example-1-reindex-into-the-same-cluster-eg-when-mapping-changes" aria-hidden="true"><span class="icon icon-link"></span></a>Example #1: reindex into the same cluster e.g when mapping changes</h3>
<p>First, we create a new index <code class="language-inline-text">new_index</code> with the updated mapping. Then we deploy a new writer <code class="language-inline-text">new_writer</code> (either the same code as <code class="language-inline-text">current_writer</code> or newer code if needed) that writes data into this index.</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 951 281' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-0eb7631f006491cd73cfb79165c698f7'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-0eb7631f006491cd73cfb79165c698f7)' width='951' height='281' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAATCAYAAAAgcwuHAAAACXBIWXMAAAsSAAALEgHS3X78AAAEEklEQVRYw92Xx24bQQyG9S55ojxVAgR5gZwD5JSLL8nJgu3YUNx7k0vcm7plq3oZfqPlZjReWc4hsWACxJYhZ8if/wx3Mw8PD9JsNqXVavUp7zqdjiBRFCVX/z70Mb92uy0m2LEGcnNzI1dXV3J5eSnn5%2bePlDGuhULB2ePnr8m8abGiZuOv%2b1ScKPllWKxarT7SSqUi5XLZLZgWDOOob2/3%2bN3d3UkojNVqNaf1ej1V8cUulPv7eykWi4/iZC6LxcA2wLvdbjIWxmr5ZQxtEMERJ6s89zYeCsGYDZVhca7ma%2bMnJyeyubnpxln84uIiCdSqgJ%2bxBgbg22g05ODgIJmHgK0Y2LKuzWHgcs/8ExMT7moAmNg6VkTmy5RKJRdELpeT9fV1WVxclKWlJVcNFliYn5fDw0OZnp52YygUJjBssF1ZWZH9/X2Zm5tzySLHx8cO4dXVVRkfH3eVYn5sCWBjY8PNtbu7697hi6ytrcny8rKcnZ3J2NiYm4/kAAZQeMYvn887u2w269hGTPgSD%2bttb287EMgPIUdiIc/r6%2buEVRn2pb%2b/E5pTUUWwqItbdY0dPjPC88GUca4EDVAIgLDP8Q/tjbYEbXMbE4wBdv8o1pgBALG1tSUzMzOys7Pjnm072fy%2bjwOARVJVgy1qFdpK4TRhYuxAOM3fgvXF9t4gP96haWcAdAWY0M%2beq3GhwoPQ4hykGXlKFCHlokQh6n9WGKwpXQAGdOMzYpAP%2b9j2bXjwPkdCZgyTTEgnP8kIqsbV8BNPxoeoBMEAQNtaa5o9lfYACNvuc/SpbZmmmQEwSnxyiMSHiFBFv7qwQxPqU2y5koBV2ksOADqcB7Qs316v7lnBbtLWPND/tQwHwGsjQR%2bErz1gQh/alfnRdmIwypp8Bz89HyLzs8NJ2YZvU0/zSgz6ywNAUEdHPdW2JhyItBAC1NPcCWPakrRXivagHjOQ01M%2b/USmpiSanBShstqaOtr%2b3BKM0TKx07YWxd3IARB0mJcBwBbni077pzZ60ebaqyxVsw8kngGDBLSFOdAQgGIO9Y201zsGaC/v6MeNWwKgsAdMBTa6vR0hAEImDNoCgAPd%2bYpjO3AlMfa518qSM0BZ0CFhTTby/ZT6EW1TfZsKZoXzYGQYwJWKm9p7gqdqqCaWKM8A4J0NfV2ARG%2b1Z9eqiU8UK35NBfXlD8Hhzfb5dn0AlKTV1m94zr6AHTKgDY4WACEzhmnAgFIJaitzKl91i/xIpn2IP43DD6HRZcBfE6YHSKPVlezYZ3n/7q3M/ppw5Sdhfmr4ecKO/4ZXCQC5dDXZL9%2b/yZsPn%2bRj/lpO9/OS%2bznr/gj5U5vXP8%2b9vT335/j6GMAZoB2Av/eFekGO6yXHgCj45OWn538y4DfFJZBC7XObzQAAAABJRU5ErkJggg==' /%3e%3c/svg%3e" width="951" alt="Example #1 Step 1" data-srcset="/assets/static/recipe-example1-step1.82a2fbd.4e48bf61819d117af66997259f36d2e3.png 480w, /assets/static/recipe-example1-step1.5321fa8.4e48bf61819d117af66997259f36d2e3.png 951w" data-sizes="(max-width: 951px) 100vw, 951px" data-src="/assets/static/recipe-example1-step1.5321fa8.4e48bf61819d117af66997259f36d2e3.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/recipe-example1-step1.5321fa8.4e48bf61819d117af66997259f36d2e3.png" width="951" alt="Example #1 Step 1"></noscript></p>
<p>Once <code class="language-inline-text">new_index</code> has caught up with <code class="language-inline-text">current_index</code>, we redirect query requests from <code class="language-inline-text">current_reader</code> to <code class="language-inline-text">new_index</code>. This can be a configuration change on <code class="language-inline-text">current_reader</code> or simply an alias update on Elasticsearch.</p>
<p>If anything goes wrong, we just need to revert the final redirect change since <code class="language-inline-text">current_index</code> is still up to date.</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 951 281' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-a9552f96b7703ddd3f55e5d8017a191d'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-a9552f96b7703ddd3f55e5d8017a191d)' width='951' height='281' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAATCAYAAAAgcwuHAAAACXBIWXMAAAsSAAALEgHS3X78AAAEYklEQVRYw92XyU4bQRCG513yRHmqRIryAjlHyimXXJJLsICACPu%2bmSXsYPCKAa9Tqa89NYzbMxgh4EBJpbanu7qr/vq7aibodrvSaDSk2Wz2Kc/a7bYgYRjGY/K3b2N2rVZLTFjHGcjl5aVcXFzI%2bfm5nJ6eDihzjFdXVwPnIuyb5itqa5LnPuQnSnwBh1Wr1QGtVCpSLpfdgQhBJAFgHk2ut9/Y3dzciC/M1Wo1p/V6PVWxZZ0P%2bO3trRSLxQE/2ct8MbAN8E6nE8/5vlp8gaENIhhiZJnnt837gjO2hsxwOKPZ2vzR0ZGsr6%2b7eQ4/OzuLHbUsYGesOYMByhQfgIraWjJYy7m2h4HLb/YfHR11owFgYufYnuwXlEol58TU1JSsrq7K/Py8LCwsuGxwwNzsrOzv78vExISbQ6EwAbKGtUtLS7K7uyszMzMuWOTw8NAhvLy8LCMjIy5T7M9aHFhbW3N7bW9vu2ezaosUdE1R5wTG6f7h3R2eSk1BgQXsj10%2bn5fFxUXJ5XKObfi0srLi/OG8zc1NBwLxIcSIL8RZKBRiVgWXHtox6mRUESwqspZdY0eSGX59MGWe8U4DACgEQLjn2Pvrjbbn6nTR9gaE6HlVM8le8VkeQ2AAQGxsbMjk5KRsbW25/3adbH//WgVkMlXV2eLJibSUwmnCxqwD4TR7czYpdvey7Nwz1bQaAF0B1dYUIxbaPtUoUX4hND%2bzNJCHRBESBSH0M3x/QramdAEY0IlqRJYN99jurd8F%2bgSAU573sfgREvhUTAYZQtVkNpKHMA5R8ZwBgJa11rT1ZNoDwN8nPlvp7a5IStBZ1zJN0xlg6OFsVEQoSn3ZhR0aUJ%2bylpEALNOJ4ACgTT2gZSXX6%2bj%2bU%2blpawnQB1hlIwyImCWPzHYqA4YCkGgjXh%2bEr4NOYEO7MjvaTgRGWYNvY6fOW3Eze9iGbUMrdAzAQ56/CgA4dXDQU21rQkGkhZA5reZOmNOWpL1StAf1mIEcH/PqJzI%2bLuHYmAiZ1dbUpsVxBHO0TNZpWwujbtTQKs461wZ5mQJkLXjy%2b7dov%2byByxmA5LPiWQGwTXFC%2b6c2ehEcI7Mgby9I/AcMAtAW5kBzDb3Q20NtQ%2b31jgH6ktPe2%2bsdQRCsB0wFNry%2b7gGgQFaizhPaXlwbBVJ2du4Tkwz%2b2QHwmZB1BQCHjPAWR6YYCQyHIxr31QBlQZuANdgwaafUdy88attQIPtqwFP9ezYGMJJxU3uO82QN1cBi5T8AJO5nXxcg0Gvt2bVqbBNGil1DQU0tglmt90WuwDB57IGRk/cAlKTZ0nd4ap/HDslogwNBP1PmnwaA78Qw9RhQKpWhjtaN73pF/sTbdqNX46wXoZeUQF5BjMp3zY7kfnyVjx/ey/S/UZd%2bAuajho8n1vHd8CYBIJaOBvvt10959%2bmLfM4X5Hg3L1N/p90XIV9qs/rluaOVni/Ht8cAaoB2AL7e5%2bpXclgvOQaEKR89r8mA//dwkAM99CJ6AAAAAElFTkSuQmCC' /%3e%3c/svg%3e" width="951" alt="Example #1 Step 2 Case 1" data-srcset="/assets/static/recipe-example1-step2-1.82a2fbd.9789040f9c536b8eff673e8ae4f96183.png 480w, /assets/static/recipe-example1-step2-1.5321fa8.9789040f9c536b8eff673e8ae4f96183.png 951w" data-sizes="(max-width: 951px) 100vw, 951px" data-src="/assets/static/recipe-example1-step2-1.5321fa8.9789040f9c536b8eff673e8ae4f96183.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/recipe-example1-step2-1.5321fa8.9789040f9c536b8eff673e8ae4f96183.png" width="951" alt="Example #1 Step 2 Case 1"></noscript></p>
<p>For complex mapping changes, we might also need to update the reader code. In these cases, we can release a new version of reader - <code class="language-inline-text">new_reader</code> that queries directly from <code class="language-inline-text">new_index</code>. Once everything looks good, we redirect requests to <code class="language-inline-text">new_reader</code> instead of <code class="language-inline-text">current_reader</code>. Again, we just need to revert the last step if anything goes wrong.</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 951 281' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-36609b8667170bc2287deab026f139a8'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-36609b8667170bc2287deab026f139a8)' width='951' height='281' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAATCAYAAAAgcwuHAAAACXBIWXMAAAsSAAALEgHS3X78AAAE4ElEQVRYw92YyW4bRxCG%2bS55ojxVAgR5gZwD5JSLAEPyRUrsCFasfbUtarP2jRRJUdw1lfp6upqt1pBUBMSHNNAYcbqqq%2bqvv6t6VHp8fJROpyPdbvfJ5F2/3xdGlmXhGf%2bd6pher9cTG8hhg3FzcyNXV1dyeXkp5%2bfnzyZrPG9vb508erFN9i3ylRn7lT6L5JnEV8JYvV5/Nmu1mtzd3TmDRc6wzozl7W/0Hh4eJB2sNRoNN5vNZuFEF7l0tFotqVQqz/xkL/PFgDYf%2bW1rqa8WX8nQBhEUBoNByDx/23o6cMZkyAxGeZqurZ%2bcnMjOzo5bx/jFxUVghWUBPWMNDEC33W7LwcFB2AeHLRnIYtf2YABESwGMAWjpHjGYZsfW2a9UrVadEwsLC7K1tSUrKyuyurrqsoGB5aUlOTw8lPn5ebfGhMI4hgyy6%2bvrsr%2b/L4uLiy5YxvHxsUN4Y2NDZmdnnYPsjywObG9vu712d3fdO3QZm5ubsra2JmdnZzI1NeX2IwiAARR%2bo1cul53cH3Nz0lC2PahPrU%2bfRIORTNmiwtKGTToZxIgvxHl9fR1YVeJcxuc70JyMKsoVNW7ZNXbEzEjrg03WeeJ002cGQDjn6KfyRl8YYnsbE4wB9vczX/3xavljl/m9CNAYEI5HzBAAwEjhVGcrmoWeUrhosDFyMKhI35yNh529UXq8YxbVAOgKMKme/a77RFmQBpT5WUFO9YmpEu1RknEDKqlClqI%2bLPGjZ0EXgAEDXyNG6XCmAamo8I61GdmLn08GfviaYjqllE5xkBlU9dmIAw/rE6YkNAWAnrXWInkyHQEQH8eX2CtqgRwHNy0ezX6c0GIGGHo4qwoBvRht2EGBiSeyPAnAMh0FBwB96oGuZ7E8TvFUsDu%2brcV6wRfeJ3rBtrXdEczwLWsYjzFgIgDemYI%2bCF9zYFId2pXp0XY8GHcafB89rQ9WqEyf7KDb0QpdM9axjwF5f0%2bvG9qL7dJC0WGPdGh3kNPToXx6BMYCwIZfv%2bZT25pQEGkhoKjV3A3WtCVprxTtiTkzGBilw7x/L9m7d8752ufP0tf250ywRstETtta5rtRl7aHjO6bvXlDX8wD1zYYzrC2U2qTLC%2bLfPkyDFT3d7LIGDu0fcv0dL7OO7vXTATAQIBa2j%2b10ecGyCyO2Eb8BgwC0BYWsgBQ7KG6mfZ6xwANoq%2bXG2cCoJDHKQU2I8PUAF2vAQos%2bfAhd5yBnLELMAiOpHjgXNAmCyOwjczMjMjbtyJHR/m7hLHju0BRJY2PAODgEAY5DjwJjHMetbJQAzQ7fQLRYLNYj8sLbVN1OxpQOAKxPV87gj07HujjBzoW3PDql4MCS/1dJK0NkxlgqNm092xO1uxs2uQ3xiKkn3QBAr3Xnt2oB53MT/Q6GkwAILbHk31jW/H0V%2bKRBTBN6IsY8BpmFAA5BKAq3Z7e4alhCTtkRBscGcw4v4qSl66NZcCEgCZeghI5A6Ba5V6uzKn9rpT9a3g/8Vfj9CKUvdLeiwF7NQP%2bNWFyp9rdgcxN/So//vC9fDz606WfgPmo4eMJOb4bngDwH49vBgCxDDTY32am5buffpGfy9dyul%2bWhb8/ui9CvtSW9Mtzb2/PfTn%2b7wBwNUA7AKVquXkrx82qY0CW/KeJj55vyYB/AOd9hyidFhbTAAAAAElFTkSuQmCC' /%3e%3c/svg%3e" width="951" alt="Example #1 Step 2 Case 2" data-srcset="/assets/static/recipe-example1-step2-2.82a2fbd.f2f8b11e4caad3d31029c7dbf51e237f.png 480w, /assets/static/recipe-example1-step2-2.5321fa8.f2f8b11e4caad3d31029c7dbf51e237f.png 951w" data-sizes="(max-width: 951px) 100vw, 951px" data-src="/assets/static/recipe-example1-step2-2.5321fa8.f2f8b11e4caad3d31029c7dbf51e237f.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/recipe-example1-step2-2.5321fa8.f2f8b11e4caad3d31029c7dbf51e237f.png" width="951" alt="Example #1 Step 2 Case 2"></noscript></p>
<h3 id="example-2-reindex-into-another-cluster-eg-when-upgrading-or-doing-migration"><a href="#example-2-reindex-into-another-cluster-eg-when-upgrading-or-doing-migration" aria-hidden="true"><span class="icon icon-link"></span></a>Example #2: reindex into another cluster e.g when upgrading or doing migration</h3>
<p>First, we create a new index <code class="language-inline-text">new_index</code> in the new cluster. Then we deploy a new writer <code class="language-inline-text">new_writer</code> that writes data into this index. <code class="language-inline-text">new_writer</code>'s code has been updated with newer Elasticsearch client library to talk to the new cluster.</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 951 351' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-718b06317b338050db1a88352ab07f6a'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-718b06317b338050db1a88352ab07f6a)' width='951' height='351' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAYCAYAAABKtPtEAAAACXBIWXMAAAsSAAALEgHS3X78AAAFBklEQVRYw92YWVNrRRDH83ksP46%2b3hcffLLKN/04%2bqwP3hepCxdkKxZJ2LewGPadBEgIIZDT9q8PHYeTcwApvUGnqms6p2emZ/69TE9yjUZDbm9vO%2bju7k5oURS1e%2bdpPq7ZbHbw3hjfarWMr9Vqsr%2b/L6enp3JwcCCHh4ePiG/Idnd327pCnfSuI6nzqb0iSzsf52ZvuYuLC7m8vBT6kK9UKnJzc2OLMDA8zNXVlZTLZaPz83MbC88B4JGHYNGur69tXWTVatUAgZynh1gjORe9rs/JdZ6dnVlfr9dt7P39fXse%2b2dceDbIvzE35yg5ar4APAPSGgpBfmlpSaampmR1dVXm5uZkenq6LWfTKFpcXLQDogMrO6j8htDHWr7hUqlkuhmLxyBnLd84%2btCztrYmIyMjtj7N9zozMyOTk5O2NnN8bdcZAsT6OT5OTEzIwsKCFAoFWxx0aIV83jY0Pj5usrz%2bZmNHR0cm39vbk/7%2bfpMNDAyYjIb85OREtre3paenx75Do6OjtiHcnIOw%2bWKxaAdxK/b29tpBWW9wcNDW4XB4Bg2gh4eHbc/0eBRtdnZWNjY2ZGhoSMbGxuxw7M9DkjWZA0DuLchz7mJO7n4t7U91Et%2bIF487tyyuPz8/bwvu7Oy0F8eNAZA5gAvPmoTAvnkAyqO2rjC08IDNzU3jsR6geOzDAyJgLy8v2zgOurKy0pazL75hMIyAbgcgzCmuzzyAgzh5TJ/Ta2JqqAXTGof02PM5Ie9WCRuol8vnclbWuZUbCfU6seG0HOBhldxnqNNDK0yAHD5Nj5PlgGTGNWIhtaD6cMxnZOUsSr0FFLSbBvGorny98EjmXhjmj6z1ntKZHPuSOTnJagx6yAVJBWkWejy1c1MNtcbedkn6fnwnhcnvVBDH4cnJsayvrz%2bytIORdQU/pTMLkKw52R6AFdRNsgB4jjqA0PV%2bz0/JZ199I1/8timlg0NZmJu1pEsuIba5TYjdLIu%2bVOffmZNLs/yDT4o8ACDPIPkcyl4INRq38uvFkfy8X5SaxmxVcwW5gYRJ/MMTm0kP%2bDfbpwNAbwEqvrtqTZpXtXZBRO88gJCZX%2brC/ykA7DrTq7SuuaDe1FJU%2bTRqBmXt2wMg7F9Cnkx9DlUZ9/JTpGOiUMebASAJwsvMb8nPWA2B6PhYInX1SIucVOINQTXZtRAID0rNnATAZbpZofZGzlWpFZjeZ/FvCHly8wqAjWM8xBjvnaeAouR9Ddj/mAeEjY2lNX8k6TtB%2bvooxEU%2bfqS2jL8DAu7OOMa4e2sS1Osg9i5%2bE%2b9UcPAcFpC2tjqN0RUP0LtZXyyiLyARXlxaoLQtzEHiV4/oq0X0ISDy4UNsPf8Oz9z372Pv4BsAeR7Qel2fdHGvNUBcLTXeEABYSuPVeqwUygAB6wES4NDry01fKY/lzFewrLDiBUaRQy7gC4XWwzNcvCRGT1cBSCbCrO/EKu5NTCdzAb85eFiRxa8hqyxb5Zq09DFkVSavPfcqyHNJ13JAMtsnk98rbgG3blRTUOwxdKyxPteZ5Z0n1Nwjup4EszzgNXWAxn1l6w/p%2beGd5Ce%2bl%2bi%2bFov1MSTF4l868IQ3C8DrSkG5f6grVqbz8vnX38qXQyWNCI33mWmJyBtjY3EiJbkSSv631f8FAEuCJFPNA7%2bc7slPuyvxf3WVCyt%2bLKcQ/9wCbzoEXgmAOAAkx1CUNv4Th8Cfp6RuBlsYwCMAAAAASUVORK5CYII=' /%3e%3c/svg%3e" width="951" alt="Example #2 Step 1" data-srcset="/assets/static/recipe-example2-step1.82a2fbd.196dccf89587c87149f801cd09d1107e.png 480w, /assets/static/recipe-example2-step1.5321fa8.196dccf89587c87149f801cd09d1107e.png 951w" data-sizes="(max-width: 951px) 100vw, 951px" data-src="/assets/static/recipe-example2-step1.5321fa8.196dccf89587c87149f801cd09d1107e.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/recipe-example2-step1.5321fa8.196dccf89587c87149f801cd09d1107e.png" width="951" alt="Example #2 Step 1"></noscript></p>
<p>Next, similar to example #1, we release a new reader <code class="language-inline-text">new_reader</code> that query from <code class="language-inline-text">new_index</code>. <code class="language-inline-text">new_reader</code>'s code has been updated with newer Elasticsearch client library. If things looks good, we switch clients to use <code class="language-inline-text">new_reader</code>. Again, this is fully revertible.</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 951 351' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-979d8725955479790671288c6b273e09'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-979d8725955479790671288c6b273e09)' width='951' height='351' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAYCAYAAABKtPtEAAAACXBIWXMAAAsSAAALEgHS3X78AAAF10lEQVRYw92YyVIjRxBA9T0Of459nYsPPjnCN/tz7LPn4LnADAzbQLCKfYfBmH2VxCKEWNTpfNmdomi6WTTGYbsiUlVdS26VmZWpQr1el6urqwdwc3MjtCiKmr2Pab7v%2bvr6wdgb%2bxuNho2r1ars7OzI0dGR7O7uyt7e3j1gjrWtra0mrZAmvdNI07xO8RqOkSNLPuSGt8LJyYmcnp4KfTiuVCpyeXlpSNgYCnN2diblctmgVCrZXsYIwJj1kBnaxcWF4WXt/PzcFAL4mB4AR/osdJ2eg9M8Pj62vlarPbgohGRfKBvgc5wtuJb84O3tbRMRG7IaBNH8/Py8jI2NydLSkkxPT8vExERzHaYhNDc3ZwJCg1t2pfINQA9cNNbW19eNNnuxGNbB5YxDDzorKyvS399v%2bGnHqjjjOwHjQ/e7JTtNl48G/gKTw8PDMjs7K%2bPj44Yc7dDGi0VjaGhoyNaK%2bg1j%2b/v7tr69vS1dXV221t3dbWs01g8PD2VjY0Pa29ttHhgYGDBhMXMEgfnl5WUTxG%2bxo6PDBAVfb2%2bv4eEijhIBUfSnT5%2bMZ/pzrE3nS1NT%2blOSSM07UmtTbUrl4KDpkuDkzKTK59YC/wU3MQc3n4b2R3qIOUzJ/c5vFtOfmZmRyclJ2dzcjJHrGDNGgZxBuYzBiQvsmAXU7I6cVuhaWMDa2pqNuXGU4r7PGCWi7IWFBds3ODgoi4uLxlsJa3WcCb6y8ujWZfOJdTg9swAEcXCfLtFrYKrrDWY1hHTf8zPhGD9PN7ReLpfkuKxnK5cS0nVAWVkxwN0qzWdIs5a4lgvqgbqJn31qESW1zlJyxmJAOuI2NaU3qDYcj3Oich5kvgKqtMs6t6GmfDF7b02CW/H4kYfvMZrWh%2bPwDGONRVHiMm4lBclrHEpiQZSB9LH2gCkist7G9sa6dP76RsZHftKF2A8PDw9kdXX13k27MvKe4DyaebRdKUJs0ItoyqeQbwHcgppJngKeggfMKL7R4ph89d0P8k3Pmqzv7sns9JQFXWIJvs1rQgDNUvRLaGae4VsVEKkCQqsuZN18YpMWVe/NtdCcIZ7Cev1K2k725e3OslTVZ4ngxAYCJv7PGN9MW8AXtxwLyHaB11KAEifjuzmvyvVZtZkQ0fsYhRCZn%2btq/ykF2HOmT1JNY0HtWlNRHWdBmNb%2b%2bxQQ9s8BDzZ%2bhjeZxOQx0D1RSKMFepJ1/osVkEb2TM37c2MBSN9hC0Ka5GQCTxTZZELPzr6QXu5FPUsB4WZy5rQCfE2ZFTIv1nkqNTPU9yz%2bBlhPMw5x9rEfYI/3PiaBIuVNn%2bXbceszaXvp2evz4M/i9cUWEDYYy2peJGmdIJ2dIuThHz%2bSW8bzMIS5s489bt4aBPU5iK2Lb/ydDI4xDMEg%2b1nXesGAi%2bDbafb1iYyOihYoIm1tseJpSa0QZFai%2bXkMnnCB37PUJy1A32atWEQrIBEqLjTu2kaQuOoRrVpiIh8%2b3DHBPGPOvnsXM8kcCvI4gABa0VmvOUCSY4tWQ7GlvH8f41S3MVyOW4s2rYJiQBn%2b/wM4tLixswDK00JNenpEcCvmwOH7n1QANwVD9NxSuIYSuD2UhHLotXLTKuX%2bOudVWZZ4UIGR5BALmCHRSsrw5g1BBwuIy7c7ocHFBbCOsj9/FhkZES0jY6HdAkJcKA7rRAFumRlxrPBoMMmbx4wwSZhMxwK%2bETzMyOJqyDLLRrkqDS2GosSfI7cqwIUOaoQmXbdA3xPGAmgmxdA93rOCaEoJ%2bRaQ9cS08Aq4MFFVlWLFkN7MxfTDRMfHCOSMt/oK5I0zXrNCSwlFK3mA%2bl7lzz%2bk/Zc3Uhz%2bWaLbarysxZAsL9/R4JbdAlrNA/KewQxlFuS1G3%2bzJea4OFGUr7//Ub7tW1ePUJOdnJCIuDE4GPs2wRWz9r%2bt/q5M8JH2jyjAa3HiwO9H2/LbVvwvjlROLPmxmIJv8x%2bEu8D/SQHiCvAkJAyO6ZblAq/Y/gLrF2A3SDKMUwAAAABJRU5ErkJggg==' /%3e%3c/svg%3e" width="951" alt="Example #2 Step 2" data-srcset="/assets/static/recipe-example2-step2.82a2fbd.0d79f615d7f440d5fd07759d8e26eb66.png 480w, /assets/static/recipe-example2-step2.5321fa8.0d79f615d7f440d5fd07759d8e26eb66.png 951w" data-sizes="(max-width: 951px) 100vw, 951px" data-src="/assets/static/recipe-example2-step2.5321fa8.0d79f615d7f440d5fd07759d8e26eb66.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/recipe-example2-step2.5321fa8.0d79f615d7f440d5fd07759d8e26eb66.png" width="951" alt="Example #2 Step 2"></noscript></p>
<h3 id="final-steps"><a href="#final-steps" aria-hidden="true"><span class="icon icon-link"></span></a>Final steps</h3>
<p>Once we're happy with the result, we just need to retire those <strong>"current"</strong> indices, writers and readers. The diagram now looks exactly like the original.</p>
<p><img class="g-image g-image--lazy g-image--loading" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 951 351' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-2033cf4ef80d10bb0829f63be19360c7'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-2033cf4ef80d10bb0829f63be19360c7)' width='951' height='351' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAAYCAYAAABKtPtEAAAACXBIWXMAAAsSAAALEgHS3X78AAAF%2bElEQVRYw92YSXNjRQzH/XE48W3gRHHgwoUDN/g4c4YTRTGBVLaZyR5ncfaNhCTO5iyOd8exn9Cv/eS0288JDhOKmq6SX7/Xi6S/1GrJqXq9Lvf39z308PAgtCiKOs9On59ms5daLff017T0m3vTPaNiUaRSkahQkKhUkqhcfuwrCcR7zKuLJ8%2bATxfP9iSxZuvQI0k/9Ea21N3dnfIsCE%2b/n8/npVaruU2cEghjyujiSBVpKTVRSOe1VJkGirCGcU8YJ1Cj0f7OuArgCJCtr%2bORjYdrea9WHT/4tLRvPB8AUd/d%2bhgE442S6OHrBtm36%2btrSRlKhnYTVGOmTEhsyrChDFfX1mR2bk42t7ZkeWVF0ouL0mItAmm7ub2VjY0NKWBZwFOmKN3SvVnvCAvFwkcAcnMjTZ17dnYmp6enbtwBoiDlVJ65hQXHZ2tnR969fy8ZlcHJCxAGWPy8VUXNk01P04/G/ik%2bzs7OypputKgbLy0tOXRo%2beVlKZ6fy9T0tBuDcUkFxI1p2WxWRkdHZUm/j42NyYXOdR6Dwjrn/OREfnv7Vm5zOefeLYRVZY6PjyWdTsvG%2brrsqCJTk5NyrWC5Y6L88ZQJ3W98YkLqdmxinqurq/JeFZ9T4D/os4TXofTurkTIxh7MVQ/JX146d3e6KBjoiX7V2EDInzIXN/LPXEEX4fa4EtZiM%2baw%2ba0KnMlkZFlBOjo6cpvTLyCwzsfSgAuYbg1WVveThu4RPfLqihN4IkBoK%2bpceDiXxmoqdFYthiE2Nzdlf39fptUwW%2bp9yOZAgk98VJ0HKCBuzIsJpm/HA250khEM7Xmu1kSxpObOKihCcQwQe7cYEC4CgArnVwMWRsFK8VnGfa2Pp/jCRkaxVY1PF0/eY0X9I4DBfN0u1SMuLi46eroYEEZcP4AYAD1zLOLa/KAfecHL5ke4ohu4VIHXO0G1I3TsBQ7YBHkkgWfX06zs94Pbq6xAF/FQzwtS0qexyGJBRwhP%2bci3TkC%2bUO25bcHyZ1n5/c1XsjT3A5q64VzuUvb29h4Z4xEBPx/YJ3kGvMNnRb2ImOED09cDQAg3CQHwLfEkefOa8ftmZkU%2b%2b%2bY7%2bWL8Tzk8O5c1jSEEpTUNbATS7e1tude4E1pzIJ6BEX2dEgFIWtQXgJc0sxxnVPu/3JzKT9ltKVYrcqeBrqxCVdTtubJKcW7hW/NjtH4AJB6Bjw1Axw25nmDeIPl5cEHRUZwEdcgLgtGnAECXNblq9UprWQrrk/et58j9XwAII%2btzFK6pxzl41zP4du/d2/%2bW33NBcCAAXuKWluQYc%2b7hsgpgOXlIXFGkwF0J0oD8%2bhnqHwHgTyZnDgGwMYQliWDcCqecpruWdBTiis5vMPcLk7BAoQ8AV1dXvYWUvvsJDXN5Mte%2bV%2bJUOSl/GMgD/IZgSc2KJBKlCc3X1zWnHx8fd9mjK4LiFBQhmWNpNOMkI1jWSm4qTvoIhICHh4dunDQVwhC8G89JrRu4Ohe0KBoZGel8B4wQNOoNyPdCS4Se9QDybRiR75NvW/oImaJYncIEJhRDJgzpJmOsHRoacsKxBvc2MObn5%2bXg4MCtXdFKkoZ1hoeHnaewH6CyD%2btNQeSiBpiZmZGpqalOsUONQHHDWmSlj2zMgTff2cPmPwsAaGEtnrU4O7MxQMB6lLokLwgFIyo7V4SoAIyznnPfrqCrDpiqc9X2%2bbYy3CwEHzzAvM%2bOIPPYk3EAYw4KU4ABqnmAvxfveCceYwZLimOpp4JJv%2b%2b4EdYGVT8WICTvpaCgMQBcAZIvK9W6ii8js1LLqxGMr1%2boMcePBfC0P2/Cqi%2bMBSEIfT0g6lOQvPQWKJdLUqs32sVQJdOzl/VRyC%2bVX3IL9Os/C8Ag18yg9zL3fPavA/njzdeSnv1Ra/xy21X1jPvFEFY20F7Kr981mARmSl65%2bXlFeiktn3/7vXz57lDy1bqsaxG0s7vrIjpnm3iBW/t/y712%2b88AcAFV48CvV1n5%2bWRLanobFO4KLl5AKE6EtiPwSQJQjpOQp1rSEXjN9jekjFxcBxMWKQAAAABJRU5ErkJggg==' /%3e%3c/svg%3e" width="951" alt="Recipe Final" data-srcset="/assets/static/recipe-final.82a2fbd.5d5425c5151979bcb5bc74e582a9b725.png 480w, /assets/static/recipe-final.5321fa8.5d5425c5151979bcb5bc74e582a9b725.png 951w" data-sizes="(max-width: 951px) 100vw, 951px" data-src="/assets/static/recipe-final.5321fa8.5d5425c5151979bcb5bc74e582a9b725.png"><noscript><img class="g-image g-image--lazy g-image--loaded" src="/assets/static/recipe-final.5321fa8.5d5425c5151979bcb5bc74e582a9b725.png" width="951" alt="Recipe Final"></noscript></p>
<h3 id="comparison-to-other-solutions"><a href="#comparison-to-other-solutions" aria-hidden="true"><span class="icon icon-link"></span></a>Comparison to other solutions</h3>
<h4 id="pros-2"><a href="#pros-2" aria-hidden="true"><span class="icon icon-link"></span></a>Pros</h4>
<ul>
<li>Not more complicated than using Index Alias.</li>
<li>Generic solution that works for all use cases.</li>
<li>All steps are incremental and revertible.</li>
<li>Zero downtime. There is a clear plan for rolling back.</li>
<li>Guarantee <a href="https://en.wikipedia.org/wiki/Eventual_consistency" target="_blank" rel="nofollow noopener noreferrer">eventual consistency</a> because of the requirements on the data source and writers.</li>
<li>Freedom in deciding when the switch/redirect happens. If implemented properly, data is kept "in sync" in near real time.</li>
</ul>
<h4 id="cons-2"><a href="#cons-2" aria-hidden="true"><span class="icon icon-link"></span></a>Cons</h4>
<ul>
<li>Not the most performance method. However, it's very flexible. For example, we can scale writers up if we want to speed up reindexing.</li>
<li>It requires organizational maturity in CI/CD/Ops to automate the process successfully. With that said, manually doing it is also not that hard since the steps are all laid out.</li>
</ul>
</div></main></div>
    <script src="/assets/js/app.185c96bb.js" defer></script><script src="/assets/js/page--src--templates--doc-vue.fff5180d.js" defer></script>
  </body>
</html>
