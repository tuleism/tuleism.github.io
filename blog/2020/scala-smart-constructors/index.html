<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Smart Constructors in Scala | Random.nextBlog</title><meta name="gridsome:hash" content="e6b294788ab7db65a6ba70474adde2638089a849"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.11"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="theme-color" content="#10c186"><meta data-vue-tag="ssr" name="google-site-verification" content="cwS6wWeYJ-lTlEh9mPtc_UOGJjRptMvsO0nOQvqrzD4"><meta data-vue-tag="ssr" name="apple-mobile-web-app-status-bar-style" content="default"><meta data-vue-tag="ssr" name="author" content="Linh Nguyen"><meta data-vue-tag="ssr" name="copyright" content="Linh Nguyen, 2021. All rights reserved"><meta data-vue-tag="ssr" property="og:image" content="https://tuleism.github.io/logo-512.png"><meta data-vue-tag="ssr" name="twitter:card" content="summary"><meta data-vue-tag="ssr" name="twitter:site" content="@tuleism"><meta data-vue-tag="ssr" name="twitter:image" content="https://tuleism.github.io/logo-512.png"><meta data-vue-tag="ssr" data-key="description" name="description" content="Sometimes, we need guarantees about the values in our program beyond what can be accomplished with the usual type system checks. Smart Constructors is one solution for this."><meta data-vue-tag="ssr" property="og:type" content="article"><meta data-vue-tag="ssr" property="og:description" content="Sometimes, we need guarantees about the values in our program beyond what can be accomplished with the usual type system checks. Smart Constructors is one solution for this."><meta data-vue-tag="ssr" property="og:site_name" content="Random.nextBlog"><meta data-vue-tag="ssr" property="og:title" content="Smart Constructors in Scala"><meta data-vue-tag="ssr" property="og:url" content="https://tuleism.github.io/blog/2020/scala-smart-constructors/"><meta data-vue-tag="ssr" name="article:author" content="Linh Nguyen"><meta data-vue-tag="ssr" name="twitter:title" content="Smart Constructors in Scala"><meta data-vue-tag="ssr" name="twitter:description" content="Sometimes, we need guarantees about the values in our program beyond what can be accomplished with the usual type system checks. Smart Constructors is one solution for this."><meta data-vue-tag="ssr" name="twitter:url" content="https://tuleism.github.io/blog/2020/scala-smart-constructors/"><meta data-vue-tag="ssr" name="article:tag" content="scala"><meta data-vue-tag="ssr" name="article:tag" content="programming"><meta data-vue-tag="ssr" name="article:tag" content="tricks"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.3229556683113e2c3373be22d950d386.png"><link data-vue-tag="ssr" rel="manifest" href="/manifest.json"><link rel="preload" href="/assets/css/0.styles.ec25256c.css" as="style"><link rel="preload" href="/assets/js/app.f0adddc4.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--doc-vue.6319a93b.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.8870d62e.js"><link rel="prefetch" href="/assets/js/page--src--pages--about-vue.c58b8302.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.4dcf9448.js"><link rel="stylesheet" href="/assets/css/0.styles.ec25256c.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="site" data-v-563cb90a data-v-2a1be845><header class="header" data-v-1c71a4d0 data-v-563cb90a><a href="/" title="Back to home" class="blog-name active" data-v-795257bb data-v-1c71a4d0><span data-v-795257bb>tuleisM &gt;&gt;= random.nextBlog</span></a><nav class="nav" data-v-1c71a4d0><button id="themeSwitch" aria-label="Switch theme between light and dark" data-v-385ac126 data-v-1c71a4d0><!----><!----></button><button aria-label="Toggle the sidebar" class="toggle" data-v-def1a688 data-v-1c71a4d0><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="open feather feather-menu" data-v-def1a688 data-v-def1a688><line x1="3" y1="12" x2="21" y2="12" data-v-def1a688></line><line x1="3" y1="6" x2="21" y2="6" data-v-def1a688></line><line x1="3" y1="18" x2="21" y2="18" data-v-def1a688></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close feather feather-x" style="display:none;" data-v-def1a688 data-v-def1a688><line x1="18" y1="6" x2="6" y2="18" data-v-def1a688></line><line x1="6" y1="6" x2="18" y2="18" data-v-def1a688></line></svg></button></nav></header><aside class="sidebar" data-v-6b719ea2 data-v-563cb90a><nav data-v-6b719ea2><hr class="dashed" data-v-6b719ea2><div align="center" data-v-6b719ea2><a href="/" title="Blog" class="topic" data-v-6b719ea2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-code" data-v-6b719ea2><polyline points="16 18 22 12 16 6" data-v-6b719ea2></polyline><polyline points="8 6 2 12 8 18" data-v-6b719ea2></polyline></svg>blog</a>
      /
      <a href="/about/" title="About Me" class="topic" data-v-6b719ea2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-info" data-v-6b719ea2><circle cx="12" cy="12" r="10" data-v-6b719ea2></circle><line x1="12" y1="16" x2="12" y2="12" data-v-6b719ea2></line><line x1="12" y1="8" x2="12" y2="8" data-v-6b719ea2></line></svg>about</a></div><div align="center" data-v-6b719ea2><a title="GitHub @tuleism" href="https://github.com/tuleism" target="_blank" rel="noopener" class="topic" data-v-6b719ea2 data-v-6b719ea2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-github" data-v-6b719ea2 data-v-6b719ea2><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-6b719ea2 data-v-6b719ea2></path></svg></a>
      /
      <a title="LinkedIn @tuleism" href="https://www.linkedin.com/in/tuleism" target="_blank" rel="noopener" class="topic" data-v-6b719ea2 data-v-6b719ea2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-linkedin" data-v-6b719ea2 data-v-6b719ea2><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-6b719ea2 data-v-6b719ea2></path><rect x="2" y="9" width="4" height="12" data-v-6b719ea2 data-v-6b719ea2></rect><circle cx="4" cy="4" r="2" data-v-6b719ea2 data-v-6b719ea2></circle></svg></a>
      /
      <a title="Instagram @randomphotohereandthere" href="https://www.instagram.com/randomphotohereandthere" target="_blank" rel="noopener" class="topic" data-v-6b719ea2 data-v-6b719ea2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-instagram" data-v-6b719ea2 data-v-6b719ea2><rect x="2" y="2" width="20" height="20" rx="5" ry="5" data-v-6b719ea2 data-v-6b719ea2></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" data-v-6b719ea2 data-v-6b719ea2></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5" data-v-6b719ea2 data-v-6b719ea2></line></svg></a>
      /
      <a title="Contact Me" href="mailto:tuleism@gmail.com" class="topic" data-v-6b719ea2 data-v-6b719ea2><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon feather feather-mail" data-v-6b719ea2 data-v-6b719ea2><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-6b719ea2 data-v-6b719ea2></path><polyline points="22,6 12,13 2,6" data-v-6b719ea2 data-v-6b719ea2></polyline></svg></a></div><hr class="dashed" data-v-6b719ea2><h3 class="section-title" data-v-6b719ea2>Table of Contents</h3><ul data-v-6b719ea2><li data-v-6b719ea2><a href="/blog/2020/scala-smart-constructors/#introduction" class="sub-topic" data-v-6b719ea2>Introduction</a></li><li data-v-6b719ea2><a href="/blog/2020/scala-smart-constructors/#the-straightforward-one-sealed-trait" class="sub-topic" data-v-6b719ea2>The Straightforward One: sealed trait</a></li><li data-v-6b719ea2><a href="/blog/2020/scala-smart-constructors/#the-confusing-one-final-case-class-private" class="sub-topic" data-v-6b719ea2>The Confusing One: final case class private</a></li><li data-v-6b719ea2><a href="/blog/2020/scala-smart-constructors/#the-tricky-one-sealed-abstract-case-class-private" class="sub-topic" data-v-6b719ea2>The Tricky One: sealed abstract case class private</a></li><li data-v-6b719ea2><a href="/blog/2020/scala-smart-constructors/#testing" class="sub-topic" data-v-6b719ea2>Testing</a></li><li data-v-6b719ea2><a href="/blog/2020/scala-smart-constructors/#summary" class="sub-topic" data-v-6b719ea2>Summary</a></li></ul></nav></aside><main class="main" data-v-563cb90a><h1 data-v-563cb90a data-v-2a1be845>
    Smart Constructors in Scala
  </h1><div class="markdown" data-v-563cb90a data-v-2a1be845><h2 id="introduction"><a href="#introduction" aria-hidden="true"><span class="icon icon-link"></span></a>Introduction</h2>
<p>Sometimes, we need guarantees about the values in our program beyond what can be accomplished with the usual type system checks.
Take for example an <code class="language-text">Email</code> type, which contains an email address:</p>
<pre class="language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> Email<span class="token punctuation">(</span>address<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span></pre>
<p>The problem with <code class="language-text">Email</code> is that <code class="language-text">address</code> can contain <strong>any</strong> value of type <code class="language-text">String</code>, even if they are not valid email addresses.
Due to that, code that uses <code class="language-text">Email</code> cannot assume that it's always a valid email address. Thus, we want to:</p>
<ol>
<li>Constrain the set of possible value for <code class="language-text">address</code> to be the set of valid email addresses.</li>
<li>Make sure every instance of <code class="language-text">Email</code> satisfies this constraint. In other words, every <code class="language-text">Email</code> instance contains a valid email address.</li>
</ol>
<p>Smart Constructors is one solution for this: instead of normal constructors, we <strong>force</strong> construction through
"smart" functions that only return <code class="language-text">Email</code> instances when the input passes validation.</p>
<p>In our case, we can use a function that returns <code class="language-text">Option[Email</code>, <code class="language-text">Either[Error, Email]</code>, etc depends on the validation
result. For demonstration, I use a very simple regex:</p>
<pre class="language-scala"><span class="token keyword">def</span> fromString<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Email<span class="token punctuation">]</span> <span class="token operator">=</span>
  NaiveEmailRegex<span class="token punctuation">.</span>findFirstIn<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_ <span class="token operator">==</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_ <span class="token keyword">=></span> <span class="token keyword">new</span> Email<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span></pre>
<p>Currently, I'm aware of 3 ways to implement Smart Constructors in Scala.</p>
<h2 id="the-straightforward-one-sealed-trait"><a href="#the-straightforward-one-sealed-trait" aria-hidden="true"><span class="icon icon-link"></span></a>The Straightforward One: <code class="language-text">sealed trait</code></h2>
<p>Using <code class="language-text">trait</code>, it is very straightforward to implement:</p>
<pre class="language-scala"><span class="token keyword">sealed</span> <span class="token keyword">trait</span> Email <span class="token punctuation">{</span>
  <span class="token keyword">def</span> value<span class="token operator">:</span> <span class="token builtin">String</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Email <span class="token punctuation">{</span>
  <span class="token keyword">def</span> fromString<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Email<span class="token punctuation">]</span> <span class="token operator">=</span>
    NaiveEmailRegex<span class="token punctuation">.</span>findFirstIn<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_ <span class="token operator">==</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span> _ <span class="token keyword">=></span>
      <span class="token keyword">new</span> Email <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">def</span> value<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> v
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
<ul>
<li>With <code class="language-text">sealed</code>, we disallow attempts to <code class="language-text">extends Email</code> from outside of this source file.</li>
<li><code class="language-text">Email.fromString</code> is the only way to construct an <code class="language-text">Email</code> from outside of this source file.</li>
</ul>
<h2 id="the-confusing-one-final-case-class-private"><a href="#the-confusing-one-final-case-class-private" aria-hidden="true"><span class="icon icon-link"></span></a>The Confusing One: <code class="language-text">final case class private</code></h2>
<p>When it comes to modeling data, especially those that are immutable, case classes is the method of choice for Scala.
Compared to traits, case classes come with many <a href="https://docs.scala-lang.org/overviews/scala-book/case-classes.html" target="_blank" rel="nofollow noopener noreferrer">useful features</a>
out of the box: pattern matching, equality comparison, copying, etc.</p>
<p>On the other hand, some of these make it harder to implement smart constructors. The implementations also differ
depends on which Scala version (and compiler flags) you are using, causing confusion for beginners.</p>
<p>Let's begin with an initial implementation in <strong>Scala 2.11</strong>:</p>
<pre class="language-scala"><span class="token keyword">final</span> <span class="token keyword">case</span> <span class="token keyword">class</span> Email <span class="token keyword">private</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> Email <span class="token punctuation">{</span>
  <span class="token keyword">def</span> fromString<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Email<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></pre>
<ul>
<li>With <code class="language-text">final</code>, we disallow attempts to <code class="language-text">extends Email</code>.</li>
<li>With <code class="language-text">private</code>, construction through <code class="language-text">new Email(value)</code> can only takes place within the current source file.</li>
</ul>
<p>However, it is still possible to create an invalid <code class="language-text">Email</code> instance:</p>
<ul>
<li>By using <code class="language-text">copy(value = &quot;badValue&quot;)</code> to create a shallow copy of an instance of <code class="language-text">Email</code> with a bad value.</li>
<li>By using <code class="language-text">Email(value = &quot;badValue&quot;)</code>, which translates to calling <code class="language-text">apply()</code> on the <code class="language-text">Email</code>'s companion object to construct an <code class="language-text">Email</code> with a bad value.</li>
</ul>
<p>To fix these problems, we need to <strong>either hide or override</strong> the <code class="language-text">copy()</code> and <code class="language-text">apply()</code> functions. For example, with <code class="language-text">apply()</code>, there are 2 choices:</p>
<ul>
<li>Override it with <code class="language-text">private</code> modifier to hide the <code class="language-text">apply()</code> function, disallowing construction through <code class="language-text">Email(value)</code>.</li>
<li>Override it with an alternative return type and implementation: <code class="language-text">Email(value)</code> is possible, but let's say, return <code class="language-text">Option[Email]</code> instead.</li>
</ul>
<h3 id="211x-and-212x"><a href="#211x-and-212x" aria-hidden="true"><span class="icon icon-link"></span></a>2.11.x and 2.12.x</h3>
<p>It turns out it is not possible to override <code class="language-text">apply()</code> in <strong>vanilla</strong> Scala 2.11.x. See this <a href="https://stackoverflow.com/questions/19462598/scala-case-class-implementation-of-smart-constructors" target="_blank" rel="nofollow noopener noreferrer">StackOverflow question</a> for more details.</p>
<p>To do that, we need to add the compiler flag <code class="language-text">-Xsource:2.12</code>, which is only available <a href="https://github.com/scala/scala/releases/tag/v2.11.11" target="_blank" rel="nofollow noopener noreferrer">after 2.11.11</a>:</p>
<blockquote>
<p>Allow custom apply and unapply methods in case class companions. Also allows case class constructors and apply methods to be private. (In 2.11.11, -Xsource:2.12 is needed to enable these changes. In Scala 2.12.2, they are on by default.)</p>
</blockquote>
<p>With this, our code becomes:</p>
<pre class="language-scala"><span class="token keyword">final</span> <span class="token keyword">case</span> <span class="token keyword">class</span> Email <span class="token keyword">private</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">def</span> copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> Email <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">def</span> apply<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Email <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span>

  <span class="token keyword">def</span> fromString<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Email<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></pre>
<p>This is the same for 2.12.x without any compiler flag.</p>
<h3 id="213x-and-dotty"><a href="#213x-and-dotty" aria-hidden="true"><span class="icon icon-link"></span></a>2.13.x and Dotty</h3>
<p>With <strong>vanilla</strong> 2.13.x, the code is the same as 2.12.x. However, <a href="https://github.com/scala/scala/releases/tag/v2.13.2" target="_blank" rel="nofollow noopener noreferrer">from 2.13.2</a>, we can reduce the boilerplate by enabling <code class="language-text">-Xsource:3</code>. From <a href="https://github.com/scala/scala/pull/7702" target="_blank" rel="nofollow noopener noreferrer">scala/scala#7702</a>:</p>
<blockquote>
<p>Backport from dotty:</p>
<ul>
<li>If a case class constructor is private or private[foo]: the synthesized copy and apply methods will have the same access modifier.</li>
<li>If a case class constructor is protected or protected[foo]: the synthesized copy method will have the same access modifier. The synthesized apply method will remain public, because protected doesn't make sense in an object.
Obviously, if a user defines a custom copy or apply method, that one—including its access modifier—will take precedence.</li>
</ul>
</blockquote>
<p>We end up with the original code that we begin with:</p>
<pre class="language-scala"><span class="token keyword">final</span> <span class="token keyword">case</span> <span class="token keyword">class</span> Email <span class="token keyword">private</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> Email <span class="token punctuation">{</span>
  <span class="token keyword">def</span> fromString<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Email<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></pre>
<p>Phew! It only takes a few Scala major releases to get what we want.</p>
<h2 id="the-tricky-one-sealed-abstract-case-class-private"><a href="#the-tricky-one-sealed-abstract-case-class-private" aria-hidden="true"><span class="icon icon-link"></span></a>The Tricky One: <code class="language-text">sealed abstract case class private</code></h2>
<p>We don't normally see <code class="language-text">abstract</code> being used on a case class. However, for smart constructors, it works wonderfully:</p>
<pre class="language-scala"><span class="token keyword">sealed</span> <span class="token keyword">abstract</span> <span class="token keyword">case</span> <span class="token keyword">class</span> Email <span class="token keyword">private</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span>

<span class="token keyword">object</span> Email <span class="token punctuation">{</span>
  <span class="token keyword">def</span> fromString<span class="token punctuation">(</span>v<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> Option<span class="token punctuation">[</span>Email<span class="token punctuation">]</span> <span class="token operator">=</span>
    NaiveEmailRegex<span class="token punctuation">.</span>findFirstIn<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_ <span class="token operator">==</span> v<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>map<span class="token punctuation">(</span>_ <span class="token keyword">=></span> <span class="token keyword">new</span> Email<span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></pre>
<ul>
<li>With <code class="language-text">sealed</code>, we disallow attempts to <code class="language-text">extends Email</code> from outside this source file.</li>
<li>With <code class="language-text">abstract</code>, we disallow construction through <code class="language-text">new Email()</code>.</li>
<li>With <code class="language-text">abstract</code>, <code class="language-text">copy()</code> and <code class="language-text">apply()</code> are not automatically generated. We don't have to worry about them.</li>
<li>It just work™! See <a href="https://gist.github.com/tpolecat/a5cb0dc9adeacc93f846835ed21c92d2" target="_blank" rel="nofollow noopener noreferrer">the original gist</a> for more details.</li>
</ul>
<h2 id="testing"><a href="#testing" aria-hidden="true"><span class="icon icon-link"></span></a>Testing</h2>
<p>We verify that our smart constructors implementation works by using a test suite to check that allowed code <strong>Compiles</strong> and the rest <strong>DoesNotCompile</strong>.</p>
<p>Below is the test suite for <code class="language-text">sealed abstract case class private</code>. The rest can be found in the <a href="https://github.com/tuleism/scala-smart-constructors" target="_blank" rel="nofollow noopener noreferrer">code repository</a>.</p>
<pre class="language-scala"><span class="token string">"AbstractCaseClassExample"</span> in <span class="token punctuation">{</span>
  <span class="token keyword">import</span> AbstractCaseClassExample<span class="token punctuation">.</span>Email
  <span class="token keyword">val</span> email <span class="token operator">=</span> Email<span class="token punctuation">.</span>fromString<span class="token punctuation">(</span>exampleEmail<span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token comment">// apply now return Option</span>
  email<span class="token punctuation">.</span>value mustBe exampleEmail <span class="token comment">// access ok</span>

  <span class="token comment">// case class's unapply()</span>
  assertCompiles<span class="token punctuation">(</span>
    <span class="token string">"""
      |email match { case Email(value) => value }
      |"""</span><span class="token punctuation">.</span>stripMargin
  <span class="token punctuation">)</span>
  <span class="token comment">// companion's apply()</span>
  assertDoesNotCompile<span class="token punctuation">(</span>
    <span class="token string">"""
      |Email(exampleEmail)
      |"""</span><span class="token punctuation">.</span>stripMargin
  <span class="token punctuation">)</span>
  <span class="token comment">// public constructor</span>
  assertDoesNotCompile<span class="token punctuation">(</span>
    <span class="token string">"""
      |new Email(exampleEmail)
      |"""</span><span class="token punctuation">.</span>stripMargin
  <span class="token punctuation">)</span>
  <span class="token comment">// extends trait</span>
  assertDoesNotCompile<span class="token punctuation">(</span>
    <span class="token string">"""
      |new Email {
      |  override def value: String = exampleEmail
      |}
      |"""</span><span class="token punctuation">.</span>stripMargin
  <span class="token punctuation">)</span>
  <span class="token comment">// case class's copy()</span>
  assertDoesNotCompile<span class="token punctuation">(</span>
    <span class="token string">"""
      |email.copy(value = exampleEmail)
      |"""</span><span class="token punctuation">.</span>stripMargin
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></pre>
<h2 id="summary"><a href="#summary" aria-hidden="true"><span class="icon icon-link"></span></a>Summary</h2>
<p>All of these allow us to implement smart constructors. My favorite one is <code class="language-text">sealed abstract case class private</code> because:</p>
<ul>
<li>It allows us to use <code class="language-text">case class</code> (instead of <code class="language-text">trait</code>, which is more verbose) and most of its <a href="https://docs.scala-lang.org/overviews/scala-book/case-classes.html" target="_blank" rel="nofollow noopener noreferrer">goodness</a>.</li>
<li>It looks the same in all Scala version. Cross-building is a breeze.</li>
</ul>
</div></main></div>
    <script>window.__INITIAL_STATE__={"data":{"metadata":{"siteName":"Random.nextBlog","siteUrl":"https:\u002F\u002Ftuleism.github.io","siteDescription":"Tech Blog on Scala, Programming, Data, Search and Distributed Systems"},"doc":{"title":"Smart Constructors in Scala","slug":"scala-smart-constructors","path":"\u002Fblog\u002F2020\u002Fscala-smart-constructors\u002F","date":"15. August 2020","timeToRead":5,"content":"\u003Ch2 id=\"introduction\"\u003E\u003Ca href=\"#introduction\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EIntroduction\u003C\u002Fh2\u003E\n\u003Cp\u003ESometimes, we need guarantees about the values in our program beyond what can be accomplished with the usual type system checks.\nTake for example an \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E type, which contains an email address:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E Email\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Eaddress\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe problem with \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E is that \u003Ccode class=\"language-text\"\u003Eaddress\u003C\u002Fcode\u003E can contain \u003Cstrong\u003Eany\u003C\u002Fstrong\u003E value of type \u003Ccode class=\"language-text\"\u003EString\u003C\u002Fcode\u003E, even if they are not valid email addresses.\nDue to that, code that uses \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E cannot assume that it's always a valid email address. Thus, we want to:\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003EConstrain the set of possible value for \u003Ccode class=\"language-text\"\u003Eaddress\u003C\u002Fcode\u003E to be the set of valid email addresses.\u003C\u002Fli\u003E\n\u003Cli\u003EMake sure every instance of \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E satisfies this constraint. In other words, every \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E instance contains a valid email address.\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cp\u003ESmart Constructors is one solution for this: instead of normal constructors, we \u003Cstrong\u003Eforce\u003C\u002Fstrong\u003E construction through\n\"smart\" functions that only return \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E instances when the input passes validation.\u003C\u002Fp\u003E\n\u003Cp\u003EIn our case, we can use a function that returns \u003Ccode class=\"language-text\"\u003EOption[Email\u003C\u002Fcode\u003E, \u003Ccode class=\"language-text\"\u003EEither[Error, Email]\u003C\u002Fcode\u003E, etc depends on the validation\nresult. For demonstration, I use a very simple regex:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E fromString\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Option\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003EEmail\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\n  NaiveEmailRegex\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EfindFirstIn\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Efilter\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E_ \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E v\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Emap\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E_ \u003Cspan class=\"token keyword\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enew\u003C\u002Fspan\u003E Email\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003ECurrently, I'm aware of 3 ways to implement Smart Constructors in Scala.\u003C\u002Fp\u003E\n\u003Ch2 id=\"the-straightforward-one-sealed-trait\"\u003E\u003Ca href=\"#the-straightforward-one-sealed-trait\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EThe Straightforward One: \u003Ccode class=\"language-text\"\u003Esealed trait\u003C\u002Fcode\u003E\u003C\u002Fh2\u003E\n\u003Cp\u003EUsing \u003Ccode class=\"language-text\"\u003Etrait\u003C\u002Fcode\u003E, it is very straightforward to implement:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token keyword\"\u003Esealed\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Etrait\u003C\u002Fspan\u003E Email \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E value\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token keyword\"\u003Eobject\u003C\u002Fspan\u003E Email \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E fromString\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Option\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003EEmail\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\n    NaiveEmailRegex\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EfindFirstIn\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Efilter\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E_ \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E v\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Emap \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E _ \u003Cspan class=\"token keyword\"\u003E=\u003E\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Enew\u003C\u002Fspan\u003E Email \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n        \u003Cspan class=\"token keyword\"\u003Eoverride\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E value\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E v\n      \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Cul\u003E\n\u003Cli\u003EWith \u003Ccode class=\"language-text\"\u003Esealed\u003C\u002Fcode\u003E, we disallow attempts to \u003Ccode class=\"language-text\"\u003Eextends Email\u003C\u002Fcode\u003E from outside of this source file.\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ccode class=\"language-text\"\u003EEmail.fromString\u003C\u002Fcode\u003E is the only way to construct an \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E from outside of this source file.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Ch2 id=\"the-confusing-one-final-case-class-private\"\u003E\u003Ca href=\"#the-confusing-one-final-case-class-private\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EThe Confusing One: \u003Ccode class=\"language-text\"\u003Efinal case class private\u003C\u002Fcode\u003E\u003C\u002Fh2\u003E\n\u003Cp\u003EWhen it comes to modeling data, especially those that are immutable, case classes is the method of choice for Scala.\nCompared to traits, case classes come with many \u003Ca href=\"https:\u002F\u002Fdocs.scala-lang.org\u002Foverviews\u002Fscala-book\u002Fcase-classes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Euseful features\u003C\u002Fa\u003E\nout of the box: pattern matching, equality comparison, copying, etc.\u003C\u002Fp\u003E\n\u003Cp\u003EOn the other hand, some of these make it harder to implement smart constructors. The implementations also differ\ndepends on which Scala version (and compiler flags) you are using, causing confusion for beginners.\u003C\u002Fp\u003E\n\u003Cp\u003ELet's begin with an initial implementation in \u003Cstrong\u003EScala 2.11\u003C\u002Fstrong\u003E:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token keyword\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E Email \u003Cspan class=\"token keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token keyword\"\u003Eobject\u003C\u002Fspan\u003E Email \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E fromString\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Option\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003EEmail\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Cul\u003E\n\u003Cli\u003EWith \u003Ccode class=\"language-text\"\u003Efinal\u003C\u002Fcode\u003E, we disallow attempts to \u003Ccode class=\"language-text\"\u003Eextends Email\u003C\u002Fcode\u003E.\u003C\u002Fli\u003E\n\u003Cli\u003EWith \u003Ccode class=\"language-text\"\u003Eprivate\u003C\u002Fcode\u003E, construction through \u003Ccode class=\"language-text\"\u003Enew Email(value)\u003C\u002Fcode\u003E can only takes place within the current source file.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003EHowever, it is still possible to create an invalid \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E instance:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EBy using \u003Ccode class=\"language-text\"\u003Ecopy(value = &quot;badValue&quot;)\u003C\u002Fcode\u003E to create a shallow copy of an instance of \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E with a bad value.\u003C\u002Fli\u003E\n\u003Cli\u003EBy using \u003Ccode class=\"language-text\"\u003EEmail(value = &quot;badValue&quot;)\u003C\u002Fcode\u003E, which translates to calling \u003Ccode class=\"language-text\"\u003Eapply()\u003C\u002Fcode\u003E on the \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E's companion object to construct an \u003Ccode class=\"language-text\"\u003EEmail\u003C\u002Fcode\u003E with a bad value.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003ETo fix these problems, we need to \u003Cstrong\u003Eeither hide or override\u003C\u002Fstrong\u003E the \u003Ccode class=\"language-text\"\u003Ecopy()\u003C\u002Fcode\u003E and \u003Ccode class=\"language-text\"\u003Eapply()\u003C\u002Fcode\u003E functions. For example, with \u003Ccode class=\"language-text\"\u003Eapply()\u003C\u002Fcode\u003E, there are 2 choices:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EOverride it with \u003Ccode class=\"language-text\"\u003Eprivate\u003C\u002Fcode\u003E modifier to hide the \u003Ccode class=\"language-text\"\u003Eapply()\u003C\u002Fcode\u003E function, disallowing construction through \u003Ccode class=\"language-text\"\u003EEmail(value)\u003C\u002Fcode\u003E.\u003C\u002Fli\u003E\n\u003Cli\u003EOverride it with an alternative return type and implementation: \u003Ccode class=\"language-text\"\u003EEmail(value)\u003C\u002Fcode\u003E is possible, but let's say, return \u003Ccode class=\"language-text\"\u003EOption[Email]\u003C\u002Fcode\u003E instead.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Ch3 id=\"211x-and-212x\"\u003E\u003Ca href=\"#211x-and-212x\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E2.11.x and 2.12.x\u003C\u002Fh3\u003E\n\u003Cp\u003EIt turns out it is not possible to override \u003Ccode class=\"language-text\"\u003Eapply()\u003C\u002Fcode\u003E in \u003Cstrong\u003Evanilla\u003C\u002Fstrong\u003E Scala 2.11.x. See this \u003Ca href=\"https:\u002F\u002Fstackoverflow.com\u002Fquestions\u002F19462598\u002Fscala-case-class-implementation-of-smart-constructors\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003EStackOverflow question\u003C\u002Fa\u003E for more details.\u003C\u002Fp\u003E\n\u003Cp\u003ETo do that, we need to add the compiler flag \u003Ccode class=\"language-text\"\u003E-Xsource:2.12\u003C\u002Fcode\u003E, which is only available \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fscala\u002Fscala\u002Freleases\u002Ftag\u002Fv2.11.11\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Eafter 2.11.11\u003C\u002Fa\u003E:\u003C\u002Fp\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003EAllow custom apply and unapply methods in case class companions. Also allows case class constructors and apply methods to be private. (In 2.11.11, -Xsource:2.12 is needed to enable these changes. In Scala 2.12.2, they are on by default.)\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cp\u003EWith this, our code becomes:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token keyword\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E Email \u003Cspan class=\"token keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E copy\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EUnit\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token keyword\"\u003Eobject\u003C\u002Fspan\u003E Email \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E apply\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Email \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E?\u003C\u002Fspan\u003E\n\n  \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E fromString\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Option\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003EEmail\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThis is the same for 2.12.x without any compiler flag.\u003C\u002Fp\u003E\n\u003Ch3 id=\"213x-and-dotty\"\u003E\u003Ca href=\"#213x-and-dotty\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E2.13.x and Dotty\u003C\u002Fh3\u003E\n\u003Cp\u003EWith \u003Cstrong\u003Evanilla\u003C\u002Fstrong\u003E 2.13.x, the code is the same as 2.12.x. However, \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fscala\u002Fscala\u002Freleases\u002Ftag\u002Fv2.13.2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Efrom 2.13.2\u003C\u002Fa\u003E, we can reduce the boilerplate by enabling \u003Ccode class=\"language-text\"\u003E-Xsource:3\u003C\u002Fcode\u003E. From \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fscala\u002Fscala\u002Fpull\u002F7702\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Escala\u002Fscala#7702\u003C\u002Fa\u003E:\u003C\u002Fp\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003EBackport from dotty:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EIf a case class constructor is private or private[foo]: the synthesized copy and apply methods will have the same access modifier.\u003C\u002Fli\u003E\n\u003Cli\u003EIf a case class constructor is protected or protected[foo]: the synthesized copy method will have the same access modifier. The synthesized apply method will remain public, because protected doesn't make sense in an object.\nObviously, if a user defines a custom copy or apply method, that one—including its access modifier—will take precedence.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cp\u003EWe end up with the original code that we begin with:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token keyword\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E Email \u003Cspan class=\"token keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token keyword\"\u003Eobject\u003C\u002Fspan\u003E Email \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E fromString\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Option\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003EEmail\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EPhew! It only takes a few Scala major releases to get what we want.\u003C\u002Fp\u003E\n\u003Ch2 id=\"the-tricky-one-sealed-abstract-case-class-private\"\u003E\u003Ca href=\"#the-tricky-one-sealed-abstract-case-class-private\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003EThe Tricky One: \u003Ccode class=\"language-text\"\u003Esealed abstract case class private\u003C\u002Fcode\u003E\u003C\u002Fh2\u003E\n\u003Cp\u003EWe don't normally see \u003Ccode class=\"language-text\"\u003Eabstract\u003C\u002Fcode\u003E being used on a case class. However, for smart constructors, it works wonderfully:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token keyword\"\u003Esealed\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eabstract\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eclass\u003C\u002Fspan\u003E Email \u003Cspan class=\"token keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Evalue\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token keyword\"\u003Eobject\u003C\u002Fspan\u003E Email \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Edef\u003C\u002Fspan\u003E fromString\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E \u003Cspan class=\"token builtin\"\u003EString\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token operator\"\u003E:\u003C\u002Fspan\u003E Option\u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003EEmail\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E\n    NaiveEmailRegex\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EfindFirstIn\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Efilter\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E_ \u003Cspan class=\"token operator\"\u003E==\u003C\u002Fspan\u003E v\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Emap\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E_ \u003Cspan class=\"token keyword\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Enew\u003C\u002Fspan\u003E Email\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ev\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Cul\u003E\n\u003Cli\u003EWith \u003Ccode class=\"language-text\"\u003Esealed\u003C\u002Fcode\u003E, we disallow attempts to \u003Ccode class=\"language-text\"\u003Eextends Email\u003C\u002Fcode\u003E from outside this source file.\u003C\u002Fli\u003E\n\u003Cli\u003EWith \u003Ccode class=\"language-text\"\u003Eabstract\u003C\u002Fcode\u003E, we disallow construction through \u003Ccode class=\"language-text\"\u003Enew Email()\u003C\u002Fcode\u003E.\u003C\u002Fli\u003E\n\u003Cli\u003EWith \u003Ccode class=\"language-text\"\u003Eabstract\u003C\u002Fcode\u003E, \u003Ccode class=\"language-text\"\u003Ecopy()\u003C\u002Fcode\u003E and \u003Ccode class=\"language-text\"\u003Eapply()\u003C\u002Fcode\u003E are not automatically generated. We don't have to worry about them.\u003C\u002Fli\u003E\n\u003Cli\u003EIt just work™! See \u003Ca href=\"https:\u002F\u002Fgist.github.com\u002Ftpolecat\u002Fa5cb0dc9adeacc93f846835ed21c92d2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Ethe original gist\u003C\u002Fa\u003E for more details.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Ch2 id=\"testing\"\u003E\u003Ca href=\"#testing\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ETesting\u003C\u002Fh2\u003E\n\u003Cp\u003EWe verify that our smart constructors implementation works by using a test suite to check that allowed code \u003Cstrong\u003ECompiles\u003C\u002Fstrong\u003E and the rest \u003Cstrong\u003EDoesNotCompile\u003C\u002Fstrong\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003EBelow is the test suite for \u003Ccode class=\"language-text\"\u003Esealed abstract case class private\u003C\u002Fcode\u003E. The rest can be found in the \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Ftuleism\u002Fscala-smart-constructors\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Ecode repository\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-scala\"\u003E\u003Cspan class=\"token string\"\u003E\"AbstractCaseClassExample\"\u003C\u002Fspan\u003E in \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Eimport\u003C\u002Fspan\u003E AbstractCaseClassExample\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EEmail\n  \u003Cspan class=\"token keyword\"\u003Eval\u003C\u002Fspan\u003E email \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E Email\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EfromString\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EexampleEmail\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Evalue \u003Cspan class=\"token comment\"\u003E\u002F\u002F apply now return Option\u003C\u002Fspan\u003E\n  email\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Evalue mustBe exampleEmail \u003Cspan class=\"token comment\"\u003E\u002F\u002F access ok\u003C\u002Fspan\u003E\n\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F case class's unapply()\u003C\u002Fspan\u003E\n  assertCompiles\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token string\"\u003E\"\"\"\n      |email match { case Email(value) =\u003E value }\n      |\"\"\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EstripMargin\n  \u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F companion's apply()\u003C\u002Fspan\u003E\n  assertDoesNotCompile\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token string\"\u003E\"\"\"\n      |Email(exampleEmail)\n      |\"\"\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EstripMargin\n  \u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F public constructor\u003C\u002Fspan\u003E\n  assertDoesNotCompile\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token string\"\u003E\"\"\"\n      |new Email(exampleEmail)\n      |\"\"\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EstripMargin\n  \u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F extends trait\u003C\u002Fspan\u003E\n  assertDoesNotCompile\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token string\"\u003E\"\"\"\n      |new Email {\n      |  override def value: String = exampleEmail\n      |}\n      |\"\"\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EstripMargin\n  \u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token comment\"\u003E\u002F\u002F case class's copy()\u003C\u002Fspan\u003E\n  assertDoesNotCompile\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token string\"\u003E\"\"\"\n      |email.copy(value = exampleEmail)\n      |\"\"\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EstripMargin\n  \u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fpre\u003E\n\u003Ch2 id=\"summary\"\u003E\u003Ca href=\"#summary\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003ESummary\u003C\u002Fh2\u003E\n\u003Cp\u003EAll of these allow us to implement smart constructors. My favorite one is \u003Ccode class=\"language-text\"\u003Esealed abstract case class private\u003C\u002Fcode\u003E because:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003EIt allows us to use \u003Ccode class=\"language-text\"\u003Ecase class\u003C\u002Fcode\u003E (instead of \u003Ccode class=\"language-text\"\u003Etrait\u003C\u002Fcode\u003E, which is more verbose) and most of its \u003Ca href=\"https:\u002F\u002Fdocs.scala-lang.org\u002Foverviews\u002Fscala-book\u002Fcase-classes.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003Egoodness\u003C\u002Fa\u003E.\u003C\u002Fli\u003E\n\u003Cli\u003EIt looks the same in all Scala version. Cross-building is a breeze.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n","description":"Sometimes, we need guarantees about the values in our program beyond what can be accomplished with the usual type system checks. Smart Constructors is one solution for this.","tags":[{"title":"scala"},{"title":"programming"},{"title":"tricks"}],"headings":[{"value":"Introduction","anchor":"#introduction","depth":2},{"value":"The Straightforward One: sealed trait","anchor":"#the-straightforward-one-sealed-trait","depth":2},{"value":"The Confusing One: final case class private","anchor":"#the-confusing-one-final-case-class-private","depth":2},{"value":"The Tricky One: sealed abstract case class private","anchor":"#the-tricky-one-sealed-abstract-case-class-private","depth":2},{"value":"Testing","anchor":"#testing","depth":2},{"value":"Summary","anchor":"#summary","depth":2}]}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.f0adddc4.js" defer></script><script src="/assets/js/page--src--templates--doc-vue.6319a93b.js" defer></script>
  </body>
</html>
